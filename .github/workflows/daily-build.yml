name: Daily build testing

on:
  repository_dispatch:
    types: [ daily-build ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CHANGE_MINIKUBE_NONE_USER: true
    strategy:
      matrix:
        guide: [ getting-started, cdi-intro, kubernetes-intro ]
        devdate: ["${{github.event.client_payload.dev-date}}"]
        java: ["${{github.event.client_payload.java}}"]
    steps:
      - run: echo Test Build - ${{github.event.client_payload.dev-date}}
      - name: Set up JDK ${{github.event.client_payload.java}}
        uses: actions/setup-java@v1
        with:
          java-version: ${{github.event.client_payload.java}}
      - run: unset _JAVA_OPTIONS
      - name: Clone ${{ matrix.guide }} repository
        uses: actions/checkout@v2
        with:
          repository: OpenLiberty/guide-${{ matrix.guide }}
          path: ${{ matrix.guide }}
          ref: refs/heads/gh-actions
      - name: Setup
        run: |
             chmod +x ${{ matrix.guide }}/scripts/*.sh
             if [ -f ${{ matrix.guide }}/scripts/testSetup.sh ]; then
               sudo ./${{ matrix.guide }}/scripts/testSetup.sh 
             fi
      - name: Update pom.xml and Dockerfile
        run: echo update pom.xml and Dockerfile
      - name: Test ${{ matrix.guide }}
        run: |
             echo ${{github.event.client_payload.dev-date}}
             cd ${{ matrix.guide }}/finish
             chmod +x ../scripts/travisTest.sh
             sudo ../scripts/travisTest.sh
      - name: Success status
        if: ${{ success() }}
        run: touch ${{ matrix.guide }}-${{github.event.client_payload.dev-date}}-${{github.event.client_payload.java}}-success
      - name: Archive status
        if: ${{ success() }}
        uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.guide }}-${{github.event.client_payload.dev-date}}-${{github.event.client_payload.java}}-success
          path: ${{ matrix.guide }}-${{github.event.client_payload.dev-date}}-${{github.event.client_payload.java}}-success
      - name: Archive server logs if failed
        if: ${{ failure() }}
        uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.guide }}-${{github.event.client_payload.dev-date}}-${{github.event.client_payload.java}}-failed-service-logs
          path: ${{ matrix.guide }}/finish/target/liberty/wlp/usr/servers/defaultServer/logs/
      - name: Post test
        if: ${{ always() }}
        run: |
             if [ -f ${{ matrix.guide }}/scripts/postTest.sh ]; then
               sudo ./${{ matrix.guide }}/scripts/postTest.sh 
             fi
