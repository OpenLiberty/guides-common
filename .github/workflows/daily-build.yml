name: Daily build testing

on:
  repository_dispatch:
    types: [ daily-build ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        guide: [ guide-getting-started, guide-cdi-intro ]
        devdate: ["${{github.event.client_payload.dev-date}}"]
    steps:
      - run: echo Test Build - ${{github.event.client_payload.dev-date}}
      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - run: unset _JAVA_OPTIONS
      - name: Clone ${{ matrix.guide }} repository
        uses: actions/checkout@v2
        with:
          repository: OpenLiberty/${{ matrix.guide }}
          path: ${{ matrix.guide }}
          ref: refs/heads/master
      - name: Test ${{ matrix.guide }}
        run: |
             echo ${{github.event.client_payload.dev-date}}
             cd ${{ matrix.guide }}/finish
             pwd
             chmod +x ../scripts/travisTest.sh
             #../scripts/travisTest.sh
      - name: Success status
        if: success()
        run: touch ${{ matrix.guide }}-${{github.event.client_payload.dev-date}}-success
        uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.guide }}-${{github.event.client_payload.dev-date}}-success
          path: ${{ matrix.guide }}-${{github.event.client_payload.dev-date}}-success
      - name: Archive server logs if failed
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: server-logs
          path: finish/target/liberty/wlp/usr/servers/guideServer/logs/
